name: Build and Submit

on:
  push:
    branches:
      - main
      - dev
      - staging

jobs:
  android:
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.meta.outputs.VERSION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com
          scope: "@tetherto"
          cache: npm

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          yes | sdkmanager --licenses

      - name: Configure Git authentication
        run: |
          git config --global url."https://${{ secrets.PAT_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git config --global url."https://${{ secrets.PAT_TOKEN }}@github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: npm ci --legacy-peer-deps

      - name: Generate Android worklet bundle
        run: npm run bundle:android

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Write Google Play service account key
        run: |
          printf '%s' '${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY_JSON }}' > google-service-account.json

      - name: Resolve EAS profile
        id: profile
        run: |
          if [[ "${GITHUB_REF##*/}" == "main" ]]; then
            echo "PROFILE=production" >> $GITHUB_OUTPUT
          else
            echo "PROFILE=preview" >> $GITHUB_OUTPUT
          fi

      - name: Read and validate Expo version
        id: meta
        run: |
          set -euo pipefail
          VERSION=$(jq -r '.expo.version' app.json)
          [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Prebuild Android
        run: npm run custom-prebuild:android

      - name: EAS build (Android local)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_GOOGLE_SERVICE_ACCOUNT_KEY_PATH: ${{ github.workspace }}/google-service-account.json
          ANDROID_HOME: /usr/local/lib/android/sdk
        run: |
          eas build \
            --platform android \
            --profile ${{ steps.profile.outputs.PROFILE }} \
            --local \
            --non-interactive

      - name: Collect Android artifact
        id: artifact
        run: |
          set -euo pipefail
          AAB=$(find . \
            \( -path "./.expo*" -o -path "./android*" \) \
            -name "*.aab" | head -n 1)

          [[ -n "$AAB" ]]
          OUT="PearPass-Mobile-Android-v${{ steps.meta.outputs.VERSION }}.aab"
          mv "$AAB" "$OUT"
          echo "AAB_PATH=$OUT" >> $GITHUB_OUTPUT

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: PearPass-Mobile-Android-v${{ steps.meta.outputs.VERSION }}.aab
          path: ${{ steps.artifact.outputs.AAB_PATH }}
